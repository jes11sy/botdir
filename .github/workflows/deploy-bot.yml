name: Deploy Telegram Bot

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Generate Prisma Client
      run: npx prisma generate
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        
    - name: Run database migrations
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
        npx prisma migrate status || echo "–ú–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
        echo "–ü—Ä–æ–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ë–î"
        echo "–ú–∏–≥—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏"
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.BOT_HOST }}
        username: ${{ secrets.BOT_USERNAME }}
        key: ${{ secrets.BOT_SSH_KEY }}
        port: ${{ secrets.BOT_SSH_PORT || 22 }}
        script: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ..."
          echo "BOT_DEPLOY_PATH: ${{ secrets.BOT_DEPLOY_PATH }}"
          echo "–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
          if [ ! -d "${{ secrets.BOT_DEPLOY_PATH }}" ]; then
            echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è ${{ secrets.BOT_DEPLOY_PATH }} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
            echo "üìÅ –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
            sudo mkdir -p ${{ secrets.BOT_DEPLOY_PATH }}
            sudo chown $USER:$USER ${{ secrets.BOT_DEPLOY_PATH }}
          fi
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –±–æ—Ç–∞
          cd ${{ secrets.BOT_DEPLOY_PATH }}
          echo "üìÇ –ü–µ—Ä–µ—à–ª–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: $(pwd)"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω –ª–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
          if [ ! -d ".git" ]; then
            echo "üì• –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
            git clone https://github.com/jes11sy/botdir.git .
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É Node.js –∏ PM2
          echo "üîß –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
          node --version || echo "‚ùå Node.js –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
          npm --version || echo "‚ùå npm –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
          pm2 --version || echo "‚ùå PM2 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞ (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω)
          pm2 stop bot || echo "–ë–æ—Ç –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω"
          pm2 stop webhook || echo "Webhook –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω"
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
          echo "üì• –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥..."
          git pull origin main
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
          npm ci --production
          
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma –∫–ª–∏–µ–Ω—Ç
          echo "üîß –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma –∫–ª–∏–µ–Ω—Ç..."
          npx prisma generate
          
          # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
          echo "üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏..."
          npx prisma migrate status || {
            echo "–°–æ–∑–¥–∞–µ–º baseline –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ë–î..."
            npx prisma migrate resolve --applied "20250920143952_add_today_stats_to_avito" || true
            npx prisma migrate resolve --applied "20250923071207_add_master_change_field" || true
            npx prisma migrate resolve --applied "20250923071427_recreate_database" || true
            npx prisma migrate resolve --applied "add_city_to_cash" || true
            npx prisma migrate resolve --applied "add_master_change_manual" || true
            npx prisma migrate resolve --applied "add_tg_id_chat_id_to_master" || true
            npx prisma migrate resolve --applied "add_tg_id_to_director" || true
          }
          npx prisma migrate deploy
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
          echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞..."
          pm2 start ecosystem.config.js --env production
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é PM2
          pm2 save
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
          echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:"
          pm2 status
